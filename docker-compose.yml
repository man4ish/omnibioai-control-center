services:
  mysql:
    image: mysql:8.0
    container_name: omnibioai-mysql
    environment:
      # IMPORTANT:
      # - Remove MYSQL_DATABASE so MySQL doesn't auto-create only one DB.
      # - Use init SQL dumps to create/import BOTH: omnibioai + limsdb.
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-root}
    ports:
      - "${MYSQL_PORT:-3306}:3306"
    volumes:
      - mysql_data:/var/lib/mysql
      # Put BOTH SQL dumps in ./db-init/:
      #   ./db-init/omnibioai.sql
      #   ./db-init/limsdb.sql
      # They will be executed automatically on first container init.
      - ./db-init:/docker-entrypoint-initdb.d:ro
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "127.0.0.1", "-uroot", "-p${MYSQL_ROOT_PASSWORD:-root}"]
      interval: 5s
      timeout: 3s
      retries: 20

  redis:
    image: redis:7-alpine
    container_name: omnibioai-redis
    ports:
      - "${REDIS_PORT:-6379}:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 20

  toolserver:
    build:
      context: ./omnibioai-toolserver
    container_name: omnibioai-toolserver
    environment:
      TOOLSERVER_RUN_STORE_DIR: /workspace/omnibioai-toolserver/out/runs
    ports:
      - "${TOOLSERVER_PORT:-9090}:9090"
    volumes:
      - workspace:/workspace
    command: >
      uvicorn toolserver_app:create_app
      --factory
      --host 0.0.0.0
      --port 9090
    healthcheck:
      test: ["CMD", "sh", "-c", "wget -qO- http://127.0.0.1:9090/health | grep -q '\"ok\":true'"]
      interval: 5s
      timeout: 5s
      retries: 30

  tes:
    build:
      context: ./omnibioai-tool-exec
    container_name: omnibioai-tes
    environment:
      HOST: 0.0.0.0
      PORT: "8080"
      TES_UPGRADE: "0"
      TOOLSERVER_BASE_URL: http://toolserver:9090
      TES_WORKDIR: /workspace/omnibioai-tool-exec/out
    ports:
      - "${TES_PORT:-8080}:8080"
    volumes:
      - workspace:/workspace
    command: ["bash", "-lc", "./scripts/restart_tes.sh"]
    depends_on:
      toolserver:
        condition: service_healthy
      redis:
        condition: service_healthy
      mysql:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "sh", "-c", "wget -qO- http://127.0.0.1:8080/health | grep -q 'ok' || exit 1"]
      interval: 5s
      timeout: 5s
      retries: 30

  omnibioai:
    build:
      context: ./omnibioai
    container_name: omnibioai-workbench
    environment:
      DEBUG: "1"
      DJANGO_SETTINGS_MODULE: omnibioai.settings

      # OmniBioAI DB (same mysql container)
      DB_HOST: mysql
      DB_PORT: "3306"
      DB_NAME: omnibioai
      DB_USER: root
      DB_PASSWORD: ${MYSQL_ROOT_PASSWORD:-root}

      # Redis / Celery / Channels
      REDIS_HOST: redis
      REDIS_PORT: "6379"
      CELERY_BROKER_URL: redis://redis:6379/1
      CELERY_RESULT_BACKEND: redis://redis:6379/2

      # Service endpoints
      TES_BASE_URL: http://tes:8080
      TOOLSERVER_BASE_URL: http://toolserver:9090

      # Workspace mount
      WORKSPACE_ROOT: /workspace
    ports:
      - "${WORKBENCH_PORT:-8000}:8000"
    volumes:
      - workspace:/workspace
    depends_on:
      tes:
        condition: service_healthy
      redis:
        condition: service_healthy
      mysql:
        condition: service_healthy
    command: ["bash", "-lc", "python manage.py migrate && python manage.py runserver 0.0.0.0:8000"]
    healthcheck:
      test: ["CMD", "sh", "-c", "wget -qO- http://127.0.0.1:8000/ | head -n 1 >/dev/null"]
      interval: 5s
      timeout: 5s
      retries: 30

  # Optional: add lims-x service (uses SAME mysql container, different DB)
  lims-x:
    build:
      context: ./lims-x
    container_name: lims-x
    environment:
      DJANGO_SETTINGS_MODULE: lab_data_manager.settings

      MYSQL_HOST: mysql
      MYSQL_PORT: "3306"
      MYSQL_DATABASE: limsdb
      MYSQL_USER: root
      MYSQL_PASSWORD: ${MYSQL_ROOT_PASSWORD:-root}

      DJANGO_DEBUG: "True"
      DJANGO_ALLOWED_HOST: 0.0.0.0
      DJANGO_SECRET_KEY: ${LIMSX_DJANGO_SECRET_KEY:-dev-secret}
    ports:
      - "${LIMSX_PORT:-7000}:7000"
    volumes:
      - workspace:/workspace
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
    command: ["bash", "-lc", "python manage.py migrate && python manage.py runserver 0.0.0.0:7000"]
    healthcheck:
      test: ["CMD", "sh", "-c", "wget -qO- http://127.0.0.1:7000/ | head -n 1 >/dev/null"]
      interval: 5s
      timeout: 5s
      retries: 30

volumes:
  mysql_data:
  workspace:
    driver: local
