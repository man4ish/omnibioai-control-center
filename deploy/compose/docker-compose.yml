services:
  mysql:
    image: mysql:8.0
    container_name: omnibioai-mysql
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-root}
      MYSQL_DATABASE: ${MYSQL_DEFAULT_DB:-omnibioai}
    volumes:
      - mysql_data:/var/lib/mysql
      - ../../db-init:/docker-entrypoint-initdb.d:ro
    healthcheck:
      test: ["CMD-SHELL", "mysqladmin ping -h 127.0.0.1 -uroot -p$$MYSQL_ROOT_PASSWORD --silent"]
      interval: 5s
      timeout: 3s
      retries: 30
    restart: unless-stopped

  redis:
    image: redis:7-alpine
    container_name: omnibioai-redis
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 30
    restart: unless-stopped

  toolserver:
    build:
      context: ../../omnibioai-toolserver
    container_name: omnibioai-toolserver
    ports:
      - "9090:9090"
    environment:
      TOOLSERVER_RUN_STORE_DIR: ${TOOLSERVER_RUN_STORE_DIR:-/workspace/omnibioai-toolserver/out/runs}
    volumes:
      - ../../:/workspace
    command: >
      uvicorn toolserver_app:create_app
      --factory
      --host 0.0.0.0
      --port 9090
    healthcheck:
      test:
        - "CMD-SHELL"
        - "python -c \"import urllib.request; urllib.request.urlopen('http://127.0.0.1:9090/health', timeout=2).read(); print('ok')\""
      interval: 5s
      timeout: 5s
      retries: 30
    restart: unless-stopped

  tes:
    build:
      context: ../../omnibioai-tes
    container_name: omnibioai-tes
    environment:
      HOST: 0.0.0.0
      PORT: "8081"
      TES_UPGRADE: ${TES_UPGRADE:-0}
      TOOLSERVER_BASE_URL: ${TOOLSERVER_BASE_URL:-http://toolserver:9090}
      TES_WORKDIR: ${TES_WORKDIR:-/workspace/omnibioai-tes/out}
      TES_TOOLS: /workspace/omnibioai-tes/configs/tools.example.yaml
      TES_SERVERS: /workspace/deploy/compose/configs/servers.local.yaml
    ports:
      - "${TES_PORT:-8081}:8081"
    volumes:
      - ../../:/workspace
    command:
      - bash
      - -lc
      - |
        cd /workspace/omnibioai-tes && \
        omnibioai-tes serve \
          --host 0.0.0.0 \
          --port 8081 \
          --tools /workspace/omnibioai-tes/configs/tools.example.yaml \
          --servers /workspace/deploy/compose/configs/servers.local.yaml
    depends_on:
      toolserver:
        condition: service_healthy
      redis:
        condition: service_healthy
      mysql:
        condition: service_healthy
    healthcheck:
      test:
        - "CMD-SHELL"
        - "python -c \"import urllib.request; urllib.request.urlopen('http://127.0.0.1:8081/health', timeout=2).read(); print('ok')\""
      interval: 5s
      timeout: 5s
      retries: 30
    restart: unless-stopped

  model-registry:
    build:
      context: ../../omnibioai-model-registry
    container_name: omnibioai-model-registry
    user: "${LOCAL_UID:-1000}:${LOCAL_GID:-1000}"
    environment:
      HOST: 0.0.0.0
      PORT: "8095"
      MODEL_REGISTRY_APP: "omnibioai_model_registry.service.app.main:app"
      DB_HOST: ${MYSQL_HOST:-mysql}
      DB_PORT: "${MYSQL_PORT:-3306}"
      DB_NAME: ${MODEL_REGISTRY_DB_NAME:-model_registry}
      DB_USER: ${MYSQL_USER:-root}
      DB_PASSWORD: ${MYSQL_ROOT_PASSWORD:-root}
      REGISTRY_ROOT: ${REGISTRY_ROOT:-/workspace/local_registry}
    ports:
      - "${MODEL_REGISTRY_PORT:-8095}:8095"
    volumes:
      - ../../:/workspace
      - ../../local_registry:/workspace/local_registry
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test:
        - "CMD-SHELL"
        - "python -c \"import urllib.request; urllib.request.urlopen('http://127.0.0.1:8095/health', timeout=2).read(); print('ok')\""
      interval: 5s
      timeout: 5s
      retries: 30
    restart: unless-stopped

  omnibioai:
    build:
      context: ../../omnibioai
    container_name: omnibioai-workbench
    environment:
      DEBUG: "1"
      DJANGO_SETTINGS_MODULE: ${DJANGO_SETTINGS_MODULE:-omnibioai.settings}
      DB_HOST: ${MYSQL_HOST:-mysql}
      DB_PORT: "${MYSQL_PORT:-3306}"
      DB_NAME: ${OMNIBIOAI_DB_NAME:-omnibioai}
      DB_USER: ${MYSQL_USER:-root}
      DB_PASSWORD: ${MYSQL_ROOT_PASSWORD:-root}
      REDIS_HOST: ${REDIS_HOST:-redis}
      REDIS_PORT: "${REDIS_PORT:-6379}"
      CELERY_BROKER_URL: ${CELERY_BROKER_URL:-redis://redis:6379/1}
      CELERY_RESULT_BACKEND: ${CELERY_RESULT_BACKEND:-redis://redis:6379/2}
      TES_BASE_URL: ${TES_BASE_URL:-http://tes:8081}
      TOOLSERVER_BASE_URL: ${TOOLSERVER_BASE_URL:-http://toolserver:9090}
      MODEL_REGISTRY_BASE_URL: ${MODEL_REGISTRY_BASE_URL:-http://model-registry:8095}
      WORKSPACE_ROOT: /workspace
    ports:
      - "${WORKBENCH_PORT:-8000}:8000"
    volumes:
      - ../../:/workspace
      - ../../data:/workspace/data
      - ../../work:/workspace/work
      - ../../out:/workspace/out
      - ../../tmpdata:/workspace/tmpdata
    depends_on:
      tes:
        condition: service_healthy
      toolserver:
        condition: service_healthy
      model-registry:
        condition: service_healthy
      redis:
        condition: service_healthy
      mysql:
        condition: service_healthy
    command: ["bash", "-lc", "python manage.py migrate && python manage.py runserver 0.0.0.0:8000"]
    healthcheck:
      test:
        - "CMD-SHELL"
        - "python -c \"import urllib.request; urllib.request.urlopen('http://127.0.0.1:8000/health/', timeout=2).read(); print('ok')\""
      interval: 5s
      timeout: 5s
      retries: 30
    restart: unless-stopped

  celery-worker:
    build:
      context: ../../omnibioai
    container_name: omnibioai-celery-worker
    environment:
      DEBUG: "1"
      DJANGO_SETTINGS_MODULE: ${DJANGO_SETTINGS_MODULE:-omnibioai.settings}
      DB_HOST: ${MYSQL_HOST:-mysql}
      DB_PORT: "${MYSQL_PORT:-3306}"
      DB_NAME: ${OMNIBIOAI_DB_NAME:-omnibioai}
      DB_USER: ${MYSQL_USER:-root}
      DB_PASSWORD: ${MYSQL_ROOT_PASSWORD:-root}
      REDIS_HOST: ${REDIS_HOST:-redis}
      REDIS_PORT: "${REDIS_PORT:-6379}"
      CELERY_BROKER_URL: ${CELERY_BROKER_URL:-redis://redis:6379/1}
      CELERY_RESULT_BACKEND: ${CELERY_RESULT_BACKEND:-redis://redis:6379/2}
      TES_BASE_URL: ${TES_BASE_URL:-http://tes:8081}
      TOOLSERVER_BASE_URL: ${TOOLSERVER_BASE_URL:-http://toolserver:9090}
      MODEL_REGISTRY_BASE_URL: ${MODEL_REGISTRY_BASE_URL:-http://model-registry:8095}
      WORKSPACE_ROOT: /workspace
    volumes:
      - ../../:/workspace
      - ../../data:/workspace/data
      - ../../work:/workspace/work
      - ../../out:/workspace/out
      - ../../tmpdata:/workspace/tmpdata
    depends_on:
      omnibioai:
        condition: service_healthy
      model-registry:
        condition: service_healthy
      redis:
        condition: service_healthy
      mysql:
        condition: service_healthy
    command: ["bash", "-lc", "celery -A omnibioai worker -l info"]
    restart: unless-stopped

  lims-x:
    build:
      context: ../../omnibioai-lims
    container_name: lims-x
    environment:
      DJANGO_SETTINGS_MODULE: lab_data_manager.settings
      MYSQL_HOST: ${MYSQL_HOST:-mysql}
      MYSQL_PORT: "${MYSQL_PORT:-3306}"
      MYSQL_DATABASE: ${LIMSX_DB_NAME:-limsdb}
      MYSQL_USER: ${MYSQL_USER:-root}
      MYSQL_PASSWORD: ${MYSQL_ROOT_PASSWORD:-root}
      DJANGO_DEBUG: "${LIMSX_DJANGO_DEBUG:-True}"
      DJANGO_SECRET_KEY: ${LIMSX_DJANGO_SECRET_KEY:-dev-secret}
      # IMPORTANT: allow requests coming from other containers by name
      DJANGO_ALLOWED_HOSTS: "127.0.0.1,localhost,lims-x"
    ports:
      - "${LIMSX_PORT:-7000}:7000"
    volumes:
      - ../../:/workspace
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
    command: ["bash", "-lc", "python manage.py migrate && python manage.py runserver 0.0.0.0:7000"]
    healthcheck:
      test:
        - "CMD-SHELL"
        - "python -c \"import urllib.request; urllib.request.urlopen('http://127.0.0.1:7000/', timeout=2).read(); print('ok')\""
      interval: 5s
      timeout: 5s
      retries: 30
    restart: unless-stopped

  control-center:
    build:
      context: ../../omnibioai-control-center
    container_name: omnibioai-control-center

    extra_hosts:
      - "host.docker.internal:host-gateway"

    environment:
      WORKBENCH_URL: http://host.docker.internal:8001
      WORKBENCH_HEALTH_PATH: /health/

      TES_URL: http://tes:8081
      TOOLSERVER_URL: http://toolserver:9090
      MODEL_REGISTRY_URL: http://model-registry:8095

      LIMSX_URL: http://lims-x:7000
      LIMSX_HEALTH_PATH: /

      MYSQL_HOST: mysql
      MYSQL_PORT: "3306"
      REDIS_HOST: redis
      REDIS_PORT: "6379"

    ports:
      - "${CONTROL_CENTER_PORT:-8100}:8100"

    command:
      - bash
      - -lc
      - uvicorn omnibioai_control_center.app.main:app --host 0.0.0.0 --port 8100

    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
      tes:
        condition: service_healthy
      toolserver:
        condition: service_healthy
      model-registry:
        condition: service_healthy

    restart: unless-stopped

volumes:
  mysql_data:
  redis_data:
