services:
  mysql:
    image: mysql:8.0
    container_name: omnibioai-mysql
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-root}
      # Optional but recommended: create DBs on first init (your db-init SQL can also do this)
      MYSQL_DATABASE: ${MYSQL_DEFAULT_DB:-omnibioai}
    volumes:
      - mysql_data:/var/lib/mysql
      - ./db-init:/docker-entrypoint-initdb.d:ro
    healthcheck:
      test: ["CMD-SHELL", "mysqladmin ping -h 127.0.0.1 -uroot -p$$MYSQL_ROOT_PASSWORD --silent"]
      interval: 5s
      timeout: 3s
      retries: 30
    restart: unless-stopped

  redis:
    image: redis:7-alpine
    container_name: omnibioai-redis
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 30
    restart: unless-stopped

  toolserver:
    build:
      context: ./omnibioai-toolserver
    container_name: omnibioai-toolserver
    environment:
      TOOLSERVER_RUN_STORE_DIR: /workspace/omnibioai-toolserver/out/runs
    volumes:
      - ./:/workspace
    command: >
      uvicorn toolserver_app:create_app
      --factory
      --host 0.0.0.0
      --port 9090
    healthcheck:
      test:
        - "CMD-SHELL"
        - "python -c \"import urllib.request; urllib.request.urlopen('http://127.0.0.1:9090/health', timeout=2).read(); print('ok')\""
      interval: 5s
      timeout: 5s
      retries: 30
    restart: unless-stopped

  tes:
    build:
      context: ./omnibioai-tes
    container_name: omnibioai-tes
    environment:
      HOST: 0.0.0.0
      PORT: "8081"
      TES_UPGRADE: "0"
      TOOLSERVER_BASE_URL: http://toolserver:9090
      TES_WORKDIR: /workspace/omnibioai-tes/out
    ports:
      - "${TES_PORT:-8081}:8081"
    volumes:
      - ./:/workspace
    command: ["bash", "-lc", "cd /workspace/omnibioai-tes && bash ./scripts/start_app.sh"]
    depends_on:
      toolserver:
        condition: service_healthy
      redis:
        condition: service_healthy
      mysql:
        condition: service_healthy
    healthcheck:
      test:
        - "CMD-SHELL"
        - "python -c \"import urllib.request; urllib.request.urlopen('http://127.0.0.1:8081/health', timeout=2).read(); print('ok')\""
      interval: 5s
      timeout: 5s
      retries: 30
    restart: unless-stopped

  omnibioai:
    build:
      context: ./omnibioai
    container_name: omnibioai-workbench
    environment:
      DEBUG: "1"
      DJANGO_SETTINGS_MODULE: omnibioai.settings

      DB_HOST: mysql
      DB_PORT: "3306"
      DB_NAME: omnibioai
      DB_USER: root
      DB_PASSWORD: ${MYSQL_ROOT_PASSWORD:-root}

      REDIS_HOST: redis
      REDIS_PORT: "6379"
      CELERY_BROKER_URL: redis://redis:6379/1
      CELERY_RESULT_BACKEND: redis://redis:6379/2

      TES_BASE_URL: http://tes:8080
      TOOLSERVER_BASE_URL: http://toolserver:9090

      WORKSPACE_ROOT: /workspace
    ports:
      - "${WORKBENCH_PORT:-8000}:8000"
    volumes:
      - ./:/workspace
      # If you truly want read-only reference data, keep it. Otherwise remove ":ro".
      - ./data:/workspace/data
      - ./work:/workspace/work
      - ./out:/workspace/out
      - ./tmpdata:/workspace/tmpdata
    depends_on:
      tes:
        condition: service_healthy
      redis:
        condition: service_healthy
      mysql:
        condition: service_healthy
    command: ["bash", "-lc", "python manage.py migrate && python manage.py runserver 0.0.0.0:8000"]
    healthcheck:
      test:
        - "CMD-SHELL"
        - "python -c \"import urllib.request; urllib.request.urlopen('http://127.0.0.1:8000/', timeout=2).read(); print('ok')\""
      interval: 5s
      timeout: 5s
      retries: 30
    restart: unless-stopped

  celery-worker:
    build:
      context: ./omnibioai
    container_name: omnibioai-celery-worker
    environment:
      DEBUG: "1"
      DJANGO_SETTINGS_MODULE: omnibioai.settings

      DB_HOST: mysql
      DB_PORT: "3306"
      DB_NAME: omnibioai
      DB_USER: root
      DB_PASSWORD: ${MYSQL_ROOT_PASSWORD:-root}

      REDIS_HOST: redis
      REDIS_PORT: "6379"
      CELERY_BROKER_URL: redis://redis:6379/1
      CELERY_RESULT_BACKEND: redis://redis:6379/2

      TES_BASE_URL: http://tes:8080
      TOOLSERVER_BASE_URL: http://toolserver:9090

      WORKSPACE_ROOT: /workspace
    volumes:
      - ./:/workspace
      - ./data:/workspace/data
      - ./work:/workspace/work
      - ./out:/workspace/out
      - ./tmpdata:/workspace/tmpdata
    depends_on:
      omnibioai:
        condition: service_healthy
      redis:
        condition: service_healthy
      mysql:
        condition: service_healthy
    command: ["bash", "-lc", "celery -A omnibioai worker -l info"]
    restart: unless-stopped

  lims-x:
    build:
      # Pick ONE of these depending on your folder name:
      # context: ./lims-x
      context: ./omnibioai-lims
    container_name: lims-x
    environment:
      DJANGO_SETTINGS_MODULE: lab_data_manager.settings

      MYSQL_HOST: mysql
      MYSQL_PORT: "3306"
      MYSQL_DATABASE: limsdb
      MYSQL_USER: root
      MYSQL_PASSWORD: ${MYSQL_ROOT_PASSWORD:-root}

      DJANGO_DEBUG: "True"
      DJANGO_SECRET_KEY: ${LIMSX_DJANGO_SECRET_KEY:-dev-secret}
      DJANGO_ALLOWED_HOSTS: "127.0.0.1,localhost"
    ports:
      - "${LIMSX_PORT:-7000}:7000"
    volumes:
      - ./:/workspace
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
    command: ["bash", "-lc", "python manage.py migrate && python manage.py runserver 0.0.0.0:7000"]
    healthcheck:
      test:
        - "CMD-SHELL"
        - "python -c \"import urllib.request; urllib.request.urlopen('http://127.0.0.1:7000/', timeout=2).read(); print('ok')\""
      interval: 5s
      timeout: 5s
      retries: 30
    restart: unless-stopped

volumes:
  mysql_data:
  redis_data:
